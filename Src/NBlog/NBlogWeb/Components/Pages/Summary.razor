@page "/summary/{dbName}/{*index}"
@layout Layout.MainLayout

@using NBlog.sdk
@using NBlogWeb.Components.Layout
@using Toolbox.Extensions
@using Toolbox.Tools
@using Toolbox.Types
@rendermode InteractiveServer

@if (_articleIds != null && _flow.State == 2)
{
    @foreach (var manifest in _articleIds.WithIndex())
    {
        <ArticleSummary ArticleId="@manifest.Item" Index="@manifest.Index" Attribute="@_attribute" DbName="@DbName" />
    }
}
else
{
    <LoadingComponent Size="0" />
}


@code {
    [Parameter] public string DbName { get; set; } = null!;
    [Parameter] public string? Index { get; set; }

    [Inject] private ArticleService _articleService { get; init; } = null!;
    [Inject] private ILogger<Home> _logger { get; init; } = null!;

    private SequentialState _flow = new SequentialState();
    private IReadOnlyList<string>? _articleIds { get; set; } = null!;
    private string? _attribute { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _flow.Reset();
            await Load();
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task Load()
    {
        var context = new ScopeContext(_logger);
        if (!_flow.MoveState(1)) return;

        try
        {
            Index = Index?.Func(x => Uri.UnescapeDataString(x));

            _articleIds = Index switch
            {
                string v when v != "home" => (await _articleService.GetIndexSummariesByName(DbName, v, context))
                    .OrderByDescending(x => x.CreatedDate)
                    .Select(x => x.ArticleId)
                    .ToArray(),

                _ => (await _articleService.GetSummaries(DbName, context))
                    .OrderByDescending(x => x.CreatedDate)
                    .Select(x => x.ArticleId)
                    .ToArray(),
            };

            _attribute = _articleIds?.Count == 1 ? NBlogConstants.MainAttribute : null;
        }
        finally
        {
            _flow.MoveState(2);
            await InvokeAsync(() => StateHasChanged());
        }
    }
}
