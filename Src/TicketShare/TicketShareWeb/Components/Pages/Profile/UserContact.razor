@rendermode InteractiveServer

@using Microsoft.FluentUI.AspNetCore.Components;
@using TicketShareWeb.Components.Pages.Profile.Models

@if (_contacts is not null)
{
    <FeedBlock Title="Contacts" Class="feed-block-datagrid">
        <FluentDataGrid Class="feed-block-datagrid" Items="@_contacts" GridTemplateColumns="70px 240px 80px" GenerateHeader=GenerateHeaderOption.None>
            <PropertyColumn Property="@(p => p.Type)" />
            <PropertyColumn Property="@(p => p.Value)" />
            <TemplateColumn>
                <FluentButton IconStart="@(new Icons.Regular.Size20.Edit())" onclick="() => EditContact(context)" />
            </TemplateColumn>
        </FluentDataGrid>
    </FeedBlock>
}


@code {
    [Inject] public IDialogService _dialogService { get; set; } = null!;
    [Parameter] public InputModel InputModel { get; set; } = null!;
    [Parameter] public EventCallback OnUpdate { get; set; }

    IDialogReference _dialog = null!;

    static List<Fluent.Option<string>> _validTypes = new()
    {
        new Fluent.Option<string> { Value = "Email", Text = "Email" },
        new Fluent.Option<string> { Value = "Phone", Text = "Phone" },
    };

    private IQueryable<ContactModel> _contacts = null!;

    protected override void OnParametersSet()
    {
        OnUpdate.HasDelegate.Assert(x => x, "OnUpdate is required");
        _contacts = InputModel.ContactItems.Values.AsQueryable();
        base.OnParametersSet();
    }

    private async Task EditContact(ContactModel model)
    {
        var parameters = new DialogParameters<ContactModel>()
            {
                Content = model,
                Alignment = HorizontalAlignment.Right,
                ShowDismiss = true,
                Title = "Edit Contact",
            };

        _dialog = await _dialogService.ShowPanelAsync<EditUserContactDialog>(model, parameters);

        var result = await _dialog.Result;
        if (result.Cancelled || result.Data is null) return;

        var data = result.Data as ContactModel;
        if (data is null) return;

        InputModel.ContactItems[data.Id] = data;
        await OnUpdate.InvokeAsync();
    }
}
